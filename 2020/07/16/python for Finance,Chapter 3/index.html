<!DOCTYPE html><html lang="zh-cn,en,default"><head><meta charset="utf-8"><title>Python for Finance Chapter3 | LEE BLOG</title><meta http-equiv="X-UA-Compatible" content="IE=Edge,chrome=1"><meta name="viewport" content="width=device-width,initial-scale=1,maximum-scale=1,user-scalable=no"><meta name="format-detection" content="telephone=no"><meta name="author" content="[object Object]"><meta name="designer" content="minfive"><meta name="keywords" content="LEE, LEE BLOG, 金融数值计算, 概率, Python"><meta name="description" content="日常学习与兴趣交流的个人博客"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-status-bar-style" content="black"><meta name="format-detection" content="telephone=yes"><meta name="mobile-web-app-capable" content="yes"><meta name="robots" content="all"><link rel="canonical" href="https://chubbylee-math.github.io/2020/07/16/python%20for%20Finance,Chapter%203/index.html"><link rel="icon" type="image/png" href="/img/favicon.ico" sizes="32x32"><link rel="stylesheet" href="/scss/base/index.css"><link rel="alternate" href="/atom.xml" title="LEE"><link rel="stylesheet" href="/scss/views/page/post.css"><meta name="generator" content="Hexo 4.2.1"><link rel="alternate" href="/atom.xml" title="LEE" type="application/atom+xml"></head><body ontouchstart><div id="page-loading" class="page page-loading" style="background-image:url(/img/loading.gif)"></div><div id="page" class="page js-hidden"><header class="page__small-header page__header--small"><nav class="page__navbar"><div class="page__container navbar-container"><a class="page__logo" href="/" title="LEE" alt="LEE"><img src="/img/logo.png" alt="LEE"></a><nav class="page__nav"><ul class="nav__list clearfix"><li class="nav__item"><a href="/" alt="首页" title="首页">首页</a></li><li class="nav__item"><a href="/archives" alt="归档" title="归档">归档</a></li><li class="nav__item"><a href="/about" alt="关于" title="关于">关于</a></li></ul></nav><button class="page__menu-btn" type="button"><i class="iconfont icon-menu"></i></button></div></nav></header><main class="page__container page__main"><div class="page__content"><article class="page__post"><div class="post__cover"><img src="/img/11.jpg" alt="Python for Finance Chapter3"></div><header class="post__info"><h1 class="post__title">Python for Finance Chapter3</h1><div class="post__mark"><div class="mark__block"><i class="mark__icon iconfont icon-write"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="https://www.github.com/ChubbyLEE-Math" target="_blank" rel="noopener">LEE</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-time"></i><ul class="mark__list clearfix"><li class="mark__item"><span>2020-07-16</span></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-tab"></i><ul class="mark__list clearfix"><li class="mark__item"><a href="/tags/Python-for-Finance/">Python for Finance</a></li></ul></div><div class="mark__block"><i class="mark__icon iconfont icon-eye"></i><ul class="mark__list clearfix"><li id="busuanzi_container_page_pv" class="mark__item"><span id="busuanzi_value_page_pv"></span>次</li></ul></div></div></header><div class="post__content"><h1 id="金融数值分析-示例"><a href="#金融数值分析-示例" class="headerlink" title="金融数值分析 示例"></a>金融数值分析 示例</h1><h2 id="BSM-模型中的两个基本问题"><a href="#BSM-模型中的两个基本问题" class="headerlink" title="BSM 模型中的两个基本问题"></a>BSM 模型中的两个基本问题</h2><ul><li>隐含波动率<br>以某些到期日的期权报价和期权定价公式反推期权的隐含波动率，并汇出图表——这是期权交易者和风险管理者每天都要面对的任务。</li><li>蒙特卡洛模拟<br>欧式期权价值的计算。通过蒙特卡罗技术，模拟股票在一段时间中变化。</li></ul><p>像Black-Scholes-Merton(1973)这样有深远影响的期权定价公式中，隐含波动率是在其他条件不变的情况下输入公式，得出不同期权行权价格和到期日测得市场报价的那些波动率值。</p><p><strong>BSM公式</strong></p>\begin{aligned} C\left(S_{t}, K, t, T, r\right) &=S_{t} \cdot N\left(d_{1}\right)-e^{-r(T-t)} \cdot K \cdot N\left(d_{2}\right) \\ N(d) &=\frac{1}{\sqrt{2 \pi}} \int_{-\infty}^{d} e^{-1 / 2} x^{2} d x \\ d_{1} &=\frac{\log \left(S_{T} / K\right)+\left(r+\sigma^{2} / 2\right)(T-t)}{\sigma \sqrt{T-t}} \\ d_{2} &=\frac{\log \left(S_{T} / K\right)+\left(r-\sigma^{2} / 2\right)(T-t)}{\sigma \sqrt{T-t}} \end{aligned}<p>不同参数有如下含义：</p><p>$S_t$ 在时点t的标的物价格水平；</p><p>$\sigma$ 标的物固定波动率（也就是收益的标准差）；</p><p>$K$ 期权行权价格；</p><p>$T$ 期权到期日；</p><p>$r$ 固定无风险短期利率；</p><p>现在考虑欧式看涨期权的一个报价 $C^*$ 已知的情况。隐含波动率 $\sigma^{imp}$ 是上述公式的隐式方程的解，它没有解析表达式，因此对于隐含波动率 $\sigma^{imp}$ 的求解采用数值方法求解，牛顿迭代法</p>\begin{aligned} C^{*}&=C\left(\sigma_{n}^{i m p}\right)+\left(\sigma_{n+1}^{i m p}-\sigma_{n}^{i m p}\right) \cdot \frac{\partial C\left(\sigma_{n}^{i m p}\right)}{\partial \sigma_{n}^{i m p}}\\ &\Longrightarrow \sigma_{n+1}^{i m p}=\sigma_{n}^{i m p}-\frac{C\left(\sigma_{n}^{i m p}\right)-C^{*}}{\partial C\left(\sigma_{n}^{i m p}\right) / \partial \sigma_{n}^{i m p}} \end{aligned}<p>期权定价公式对于波动率的偏微分称作希腊字母 Vega，可以得出了 Vega 的闭合方式。</p><p>$$<br>\frac{\partial C}{\partial \sigma}=S_tN(d_1)\sqrt{T-t}<br>$$</p><h2 id="Black-Scholes-Merton-python计算公式"><a href="#Black-Scholes-Merton-python计算公式" class="headerlink" title="Black-Scholes-Merton python计算公式"></a>Black-Scholes-Merton python计算公式</h2><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> sqrt, log</span><br><span class="line"><span class="keyword">from</span> scipy <span class="keyword">import</span> stats</span><br><span class="line"><span class="comment">#</span></span><br><span class="line"><span class="comment"># 欧式期权BSM定价公式</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bsm_call_value</span><span class="params">(S0, K, T, r, sigma)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Parameters:</span></span><br><span class="line"><span class="string">    ==========</span></span><br><span class="line"><span class="string">    S0: float</span></span><br><span class="line"><span class="string">        标的物初始价格水平</span></span><br><span class="line"><span class="string">    K: float</span></span><br><span class="line"><span class="string">       行权价格</span></span><br><span class="line"><span class="string">    T: float</span></span><br><span class="line"><span class="string">       到期日</span></span><br><span class="line"><span class="string">    r: float</span></span><br><span class="line"><span class="string">       固定无风险短期利率</span></span><br><span class="line"><span class="string">    sigma: float</span></span><br><span class="line"><span class="string">       波动因子</span></span><br><span class="line"><span class="string">       </span></span><br><span class="line"><span class="string">    Returns</span></span><br><span class="line"><span class="string">    ==========</span></span><br><span class="line"><span class="string">    value: float</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    S0 = float(S0)</span><br><span class="line">    d1 = (np.log(S0 /K) + (r + <span class="number">0.5</span> * sigma**<span class="number">2</span>) * T )/(sigma * np.sqrt(T))</span><br><span class="line">    d2 = (np.log(S0 /K) + (r - <span class="number">0.5</span> * sigma**<span class="number">2</span>) * T )/(sigma * np.sqrt(T))</span><br><span class="line">    value = (S0 * stats.norm.cdf(d1, <span class="number">0</span>, <span class="number">1</span>) - K * np.exp(-r * T) * stats.norm.cdf(d2, <span class="number">0</span>, <span class="number">1</span>))</span><br><span class="line">    <span class="keyword">return</span> value</span><br><span class="line">    </span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bsm_vega</span><span class="params">(S0, K, T, r, sigma)</span>:</span></span><br><span class="line">    <span class="string">"""</span></span><br><span class="line"><span class="string">    Vega 计算</span></span><br><span class="line"><span class="string">    """</span></span><br><span class="line">    S0 = float(S0)</span><br><span class="line">    d1 = (np.log(S0/K)) + (r+<span class="number">0.5</span>*sigma**<span class="number">2</span>)*T /(sigma*sqrt(T))</span><br><span class="line">    vega = S0 * stats.norm.cdf(d1, <span class="number">0</span>, <span class="number">1</span>) * np.sqrt(T)</span><br><span class="line">    <span class="keyword">return</span> vega</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">bsm_call_imp_vol</span><span class="params">(S0, K, T, r, C0, sigma_est, it=<span class="number">100</span>)</span>:</span></span><br><span class="line">    <span class="keyword">for</span> i <span class="keyword">in</span> range(it):</span><br><span class="line">        sigma_est -= ((bsm_call_value(S0, K, T, r, sigma_est) - C0)</span><br><span class="line">                     / bsm_vega(S0, K, T, r, sigma_est))</span><br><span class="line">    <span class="keyword">return</span> sigma_est</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">S0 = <span class="number">1</span></span><br><span class="line">K = <span class="number">2</span></span><br><span class="line">T = <span class="number">2</span></span><br><span class="line">r = <span class="number">0.01</span></span><br><span class="line">sigma = <span class="number">0.1</span></span><br><span class="line">C0 = <span class="number">0.01</span></span><br><span class="line">bsm_call_imp_vol(S0, K, T, r, C0, sigma, it=<span class="number">100</span>) </span><br><span class="line"><span class="comment"># 牛顿迭代的收敛性很好 一般几步就能收敛了，牛顿迭代的关键是初值的选取，选不好很容易发散</span></span><br></pre></td></tr></table></figure><p>结果：0.2800420290586886</p><p>vxtoxx 为例，比较特殊的 h5 型数据，类似数据库式的数据，后期可以用 SQL 作为数据储存工具，读取csv。但是书中示例式这个。</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line">h5 = pd.HDFStore(<span class="string">'./vstoxx_data_31032014.h5'</span>,<span class="string">'r'</span>) <span class="comment">#使用 pandas.HDFStore 创建 </span></span><br><span class="line">futures_data = h5[<span class="string">'futures_data'</span>] </span><br><span class="line">options_data = h5[<span class="string">'options_data'</span>]</span><br><span class="line"><span class="comment"># 源文件中‘Data' 是 datetime64[ns] 时间类型，但是直接读取成了int64，因此将他的数据类型转换一下</span></span><br><span class="line">futures_data[<span class="string">'DATE'</span>] = pd.to_datetime(futures_data[<span class="string">'DATE'</span>]) </span><br><span class="line">options_data[<span class="string">'DATE'</span>] = pd.to_datetime(options_data[<span class="string">'DATE'</span>])</span><br><span class="line">futures_data[<span class="string">'MATURITY'</span>] = pd.to_datetime(futures_data[<span class="string">'MATURITY'</span>])</span><br><span class="line">options_data[<span class="string">'MATURITY'</span>] = pd.to_datetime(options_data[<span class="string">'MATURITY'</span>])</span><br><span class="line">h5.close()</span><br><span class="line">options_data.info() <span class="comment"># 看一下期权数据的整体情况</span></span><br></pre></td></tr></table></figure><p>结果如下所示，因为在每个交易日，根据行权价格，看涨看跌，期权行权时间，更甚还可以各种障碍条款的亚式、欧式、美式的各种期权，因此期权的种类是多种多样的。在2014-3-31日 vstoxx 欧式期权的种类就有395种看涨期权。</p><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">&lt;class &#39;pandas.core.frame.DataFrame&#39;&gt;</span><br><span class="line">Int64Index: 395 entries, 46170 to 46564</span><br><span class="line">Data columns (total 8 columns):</span><br><span class="line"> #   Column     Non-Null Count  Dtype         </span><br><span class="line">---  ------     --------------  -----         </span><br><span class="line"> 0   DATE       395 non-null    datetime64[ns]</span><br><span class="line"> 1   EXP_YEAR   395 non-null    int64         </span><br><span class="line"> 2   EXP_MONTH  395 non-null    int64         </span><br><span class="line"> 3   TYPE       395 non-null    object        </span><br><span class="line"> 4   STRIKE     395 non-null    float64       </span><br><span class="line"> 5   PRICE      395 non-null    float64       </span><br><span class="line"> 6   MATURITY   395 non-null    datetime64[ns]</span><br><span class="line"> 7   TTM        395 non-null    float64       </span><br><span class="line">dtypes: datetime64[ns](2), float64(3), int64(2), object(1)</span><br><span class="line">memory usage: 27.8+ KB</span><br></pre></td></tr></table></figure><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">options_data.head() <span class="comment"># 看一下头几行长什么样</span></span><br></pre></td></tr></table></figure><table><thead><tr><th align="left"></th><th align="center">DATE</th><th align="center">EXP_YEAR</th><th align="center">EXP_MONTH</th><th align="center">TYPE</th><th align="center">STRIKE</th><th align="right">PRICE</th><th align="center">MATURITY</th><th align="center">TTM</th></tr></thead><tbody><tr><td align="left">46170</td><td align="center">2014-03-31</td><td align="center">2014</td><td align="center">4</td><td align="center">C</td><td align="center">1.0</td><td align="right">16.85</td><td align="center">2014-04-18</td><td align="center">0.049</td></tr><tr><td align="left">46171</td><td align="center">2014-03-31</td><td align="center">2014</td><td align="center">4</td><td align="center">C</td><td align="center">2.0</td><td align="right">15.85</td><td align="center">2014-04-18</td><td align="center">0.049</td></tr><tr><td align="left">46172</td><td align="center">2014-03-31</td><td align="center">2014</td><td align="center">4</td><td align="center">C</td><td align="center">3.0</td><td align="right">14.85</td><td align="center">2014-04-18</td><td align="center">0.049</td></tr><tr><td align="left">46173</td><td align="center">2014-03-31</td><td align="center">2014</td><td align="center">4</td><td align="center">C</td><td align="center">4.0</td><td align="right">13.85</td><td align="center">2014-04-18</td><td align="center">0.049</td></tr><tr><td align="left">46174</td><td align="center">2014-03-31</td><td align="center">2014</td><td align="center">4</td><td align="center">C</td><td align="center">5.0</td><td align="right">12.85</td><td align="center">2014-04-18</td><td align="center">0.049</td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">futures_data.head() <span class="comment"># 看一下期货的头几行</span></span><br></pre></td></tr></table></figure><table><thead><tr><th align="left"></th><th align="right">DATE</th><th align="right">EXP_YEAR</th><th align="right">EXP_MONTH</th><th align="right">PRICE</th><th align="right">MATURITY</th><th align="right">TTM</th></tr></thead><tbody><tr><td align="left">496</td><td align="right">2014-03-31</td><td align="right">2014</td><td align="right">4</td><td align="right">17.85</td><td align="right">2014-04-18</td><td align="right">0.049</td></tr><tr><td align="left">497</td><td align="right">2014-03-31</td><td align="right">2014</td><td align="right">5</td><td align="right">19.55</td><td align="right">2014-05-16</td><td align="right">0.126</td></tr><tr><td align="left">498</td><td align="right">2014-03-31</td><td align="right">2014</td><td align="right">6</td><td align="right">19.95</td><td align="right">2014-06-20</td><td align="right">0.222</td></tr><tr><td align="left">499</td><td align="right">2014-03-31</td><td align="right">2014</td><td align="right">7</td><td align="right">20.40</td><td align="right">2014-07-18</td><td align="right">0.299</td></tr><tr><td align="left">500</td><td align="right">2014-03-31</td><td align="right">2014</td><td align="right">8</td><td align="right">20.70</td><td align="right">2014-08-15</td><td align="right">0.375</td></tr></tbody></table><p>可以发现，一些期权是很便宜的价内期权（指数水平远高于期权的行权价格）。因此我们应该根据对应到期日的期货价值，分析具有一定（远期）价值的看涨期权。允许与期货水平之间的最大偏差为50%</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br></pre></td><td class="code"><pre><span class="line">V0 = <span class="number">17.6639</span></span><br><span class="line">r = <span class="number">0.01</span></span><br><span class="line"><span class="comment"># imp_vol  -&gt; implied volality</span></span><br><span class="line">options_data[<span class="string">'IMP_VOL'</span>] = <span class="number">0.0</span> <span class="comment"># new colum for implied volatilities</span></span><br><span class="line">tol = <span class="number">0.5</span> <span class="comment"># tolerance level for moneyness </span></span><br><span class="line"><span class="keyword">for</span> option <span class="keyword">in</span> options_data.index:</span><br><span class="line">    <span class="comment"># iterating over all option quotes</span></span><br><span class="line">    item = options_data.loc[option] </span><br><span class="line">    forward = futures_data[futures_data[<span class="string">'MATURITY'</span>]== \</span><br><span class="line">                           item[<span class="string">'MATURITY'</span>]][<span class="string">'PRICE'</span>].values[<span class="number">0</span>]</span><br><span class="line">    <span class="comment"># picking the right futures value</span></span><br><span class="line">    <span class="keyword">if</span> (forward * (<span class="number">1</span> - tol) &lt; item[<span class="string">'STRIKE'</span>] </span><br><span class="line">        &lt; forward*(<span class="number">1</span> + tol)):</span><br><span class="line">        <span class="comment"># only for options with moneyness tolerness </span></span><br><span class="line">        imp_vol = bsm_call_imp_vol(V0,</span><br><span class="line">                                  item[<span class="string">'STRIKE'</span>],</span><br><span class="line">                                  item[<span class="string">'TTM'</span>],</span><br><span class="line">                                  r,</span><br><span class="line">                                  item[<span class="string">'PRICE'</span>],</span><br><span class="line">                                  sigma_est=<span class="number">2.</span>,</span><br><span class="line">                                  it=<span class="number">100</span>)</span><br><span class="line">        options_data[<span class="string">'IMP_VOL'</span>].loc[option] = imp_vol</span><br></pre></td></tr></table></figure><ul><li>准备画图数据</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">plot_data = options_data[options_data[<span class="string">'IMP_VOL'</span>]&gt;<span class="number">0</span>]</span><br><span class="line">maturies = sorted(set(options_data[<span class="string">'MATURITY'</span>])) <span class="comment">#到期日排序和去重 </span></span><br><span class="line">matures <span class="comment"># 可以看一下到期日情况</span></span><br></pre></td></tr></table></figure><figure class="highlight plain"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">[Timestamp(&#39;2014-04-18 00:00:00&#39;),</span><br><span class="line"> Timestamp(&#39;2014-05-16 00:00:00&#39;),</span><br><span class="line"> Timestamp(&#39;2014-06-20 00:00:00&#39;),</span><br><span class="line"> Timestamp(&#39;2014-07-18 00:00:00&#39;),</span><br><span class="line"> Timestamp(&#39;2014-08-15 00:00:00&#39;),</span><br><span class="line"> Timestamp(&#39;2014-09-19 00:00:00&#39;),</span><br><span class="line"> Timestamp(&#39;2014-10-17 00:00:00&#39;),</span><br><span class="line"> Timestamp(&#39;2014-11-21 00:00:00&#39;)]</span><br></pre></td></tr></table></figure><ul><li>画图</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">plt.figure(figsize=(<span class="number">8</span>, <span class="number">6</span>))</span><br><span class="line"><span class="keyword">for</span> maturity <span class="keyword">in</span> maturies:</span><br><span class="line">    data = plot_data[options_data.MATURITY==maturity]</span><br><span class="line">    plt.plot(data[<span class="string">'STRIKE'</span>], data[<span class="string">'IMP_VOL'</span>], label=maturity.date(), lw=<span class="number">1.5</span></span><br><span class="line">            )</span><br><span class="line">    plt.plot(data[<span class="string">'STRIKE'</span>], data[<span class="string">'IMP_VOL'</span>], <span class="string">'r.'</span>)</span><br><span class="line">plt.grid(<span class="literal">True</span>)</span><br><span class="line">plt.xlabel(<span class="string">'strike'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'implied volatility of volatility'</span>)</span><br><span class="line">plt.legend()</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p><img src="/img/Chapter1/2.1.png" alt="21"></p><p>在股票或外汇市场中，你将注意到所谓的隐含波动率微笑，而且到期日越短，隐含波动率微笑越明显；到期日越长，越不明显。</p><h2 id="期权定价的蒙特卡罗模拟"><a href="#期权定价的蒙特卡罗模拟" class="headerlink" title="期权定价的蒙特卡罗模拟"></a>期权定价的蒙特卡罗模拟</h2><p>蒙特卡罗是金融学和数值科学中最重要的算法之一。它之所以重要，是因为在期权定价或者风险管理问题上有很强的能力。和其他数值方法相比，蒙特卡罗方法很容易处理高维问题，在这种问题上复杂度和计算需求通常以线性方式增大。一下例子阐述了python的基于蒙特卡罗模拟的欧式期权估值方法。</p><p><strong>Black-Scholes-Merton随机微分方程</strong><br>$$<br>dS_t=rS_tdt+\sigma S_tdZ_t<br>$$<br>其中， $Z_t$ 是一个布朗运动</p><p><strong>上述 SDE 方程的欧拉离散</strong><br>$$<br>S_t=S_{t-\Delta_t}\ exp\lgroup \lgroup r -\frac{1}{2}\sigma^2\rgroup \Delta t+\sigma \sqrt{\Delta t}z_t\rgroup<br>$$<br>变量Z是标准正态分布随机变量，$0&lt;\Delta_t&lt;T$，是一个足够小的时间间隔。以 $S0=100、$$K=105、$$T=1.0、$$r=0.05、$$\sigma=0.2$ 参数化上述模型，利用前面例子中的计算公式，可以得到精确的期权价值：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">S0 = <span class="number">100</span></span><br><span class="line">K = <span class="number">105</span></span><br><span class="line">T = <span class="number">1.0</span></span><br><span class="line">r = <span class="number">0.05</span></span><br><span class="line">sigma = <span class="number">0.2</span></span><br><span class="line">bsm_call_value(S0, K, T, r, sigma)</span><br></pre></td></tr></table></figure><p>结果：8.021352235143176</p><p><strong>蒙特卡罗算法流程：</strong></p><ol><li><p>将时间间隔 [0,T] 分为等距的、长度为$\Delta_t$的子时段。</p></li><li><p>开始循环 $i=1,2,\cdots, l。$</p></li></ol><p>(a) 对于每个时间步$t\in {\Delta_t, 2\Delta_t,\dots, T }$，取伪随机数 Z_t(i)。</p><p>(b) 逐个时间步应用伪随机数，确定指数水平$S_T(i)$的T值，以离散化公式2-2的方案</p><p>(c) 确定T时点欧式看涨期权的内在价值：$h_t:h_t(ST(i))=max(ST(i)-K, 0)$</p><p>(d) 循环到 $i=I$</p><ol start="3"><li><p>根据公式2-3，加总内在价值，求平均值，并扣除无风险短期利率。</p></li><li><p>公式 2-3 欧式看涨期权的蒙特卡罗估算函数：</p></li></ol><p>$$<br>C_0\approx e^{-rT}\frac{1}{I}\sum_Ih_T(S_T(i))<br>$$</p><h3 id="纯-python"><a href="#纯-python" class="headerlink" title="纯 python"></a>纯 python</h3><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time</span><br><span class="line"><span class="keyword">from</span> math <span class="keyword">import</span> exp, sqrt, log</span><br><span class="line"><span class="keyword">from</span> random <span class="keyword">import</span> gauss, seed</span><br><span class="line">seed(<span class="number">20000</span>)</span><br><span class="line">t0 = time()</span><br><span class="line"><span class="comment"># 参数设定</span></span><br><span class="line">S0 = <span class="number">100.</span></span><br><span class="line">K = <span class="number">105.</span></span><br><span class="line">T = <span class="number">1.</span></span><br><span class="line">r = <span class="number">0.05</span></span><br><span class="line">sigma = <span class="number">0.2</span></span><br><span class="line">M = <span class="number">50</span> <span class="comment"># 时间步长</span></span><br><span class="line">dt = T / M</span><br><span class="line">I = <span class="number">250000</span></span><br><span class="line">S = []</span><br><span class="line"></span><br><span class="line"><span class="comment"># M步循环</span></span><br><span class="line"><span class="keyword">for</span> i <span class="keyword">in</span> range(I):</span><br><span class="line">    path = []</span><br><span class="line">    <span class="keyword">for</span> t <span class="keyword">in</span> range(M+<span class="number">1</span>):</span><br><span class="line">        <span class="keyword">if</span> t == <span class="number">0</span> :</span><br><span class="line">            path.append(S0)</span><br><span class="line">        <span class="keyword">else</span>:</span><br><span class="line">            z = gauss(<span class="number">0</span>, <span class="number">1</span>)</span><br><span class="line">            St = path[t<span class="number">-1</span>] * exp((r - <span class="number">0.5</span> * sigma **<span class="number">2</span>) * dt </span><br><span class="line">                                + sigma * sqrt(dt) * z)</span><br><span class="line">            path.append(St)</span><br><span class="line">    S.append(path)</span><br><span class="line">C0 = exp(-r * T) * sum([max(path[<span class="number">-1</span>] - K, <span class="number">0</span>) <span class="keyword">for</span> path <span class="keyword">in</span> S])/ I</span><br><span class="line">print(<span class="string">f'欧式期权定价 <span class="subst">&#123;C0&#125;</span>.'</span>)</span><br><span class="line">print(<span class="string">f'共计花费时间 <span class="subst">&#123;np.round(time()-t0,<span class="number">1</span>) &#125;</span>s.'</span>)</span><br></pre></td></tr></table></figure><p>结果：</p><p>欧式期权定价 7.9990448881765825.</p><p>共计花费时间 24.1s.</p><h3 id="Numpy-向量化"><a href="#Numpy-向量化" class="headerlink" title="Numpy 向量化"></a>Numpy 向量化</h3><p>使用 Numpy 的欧式看涨期权蒙特卡罗估值（第一个版本）</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">from</span> time <span class="keyword">import</span> time</span><br><span class="line"></span><br><span class="line">np.random.seed(<span class="number">20000</span>)</span><br><span class="line">t0 = time()</span><br><span class="line"><span class="comment"># Parameters</span></span><br><span class="line">S0 = <span class="number">100.</span>; K = <span class="number">105.</span>; T = <span class="number">1.0</span>; r = <span class="number">0.05</span>; sigma = <span class="number">0.2</span></span><br><span class="line">M = <span class="number">50</span>; dt = T/M; I = <span class="number">250000</span></span><br><span class="line"></span><br><span class="line"><span class="comment"># Simulating I paths with M time steps</span></span><br><span class="line">S = np.zeros((I, M+<span class="number">1</span>))</span><br><span class="line">S[:,<span class="number">0</span>] = S0</span><br><span class="line"><span class="keyword">for</span> t <span class="keyword">in</span> range(<span class="number">1</span>,M+<span class="number">1</span>):</span><br><span class="line">    z = np.random.standard_normal(I) <span class="comment"># pseudorandom numbers</span></span><br><span class="line">    S[:,t] = S[:,t<span class="number">-1</span>] * np.exp((r - <span class="number">0.5</span> * sigma **<span class="number">2</span>) * dt + sigma * math.sqrt(dt) *z)</span><br><span class="line">C0 = math.exp(-r * T) *np.sum(np.maximum(S[:,<span class="number">-1</span>]-K,<span class="number">0</span>)) / I</span><br><span class="line">tnp1 = time() - t0</span><br><span class="line">print(<span class="string">'Europen Option Value %7.3f'</span> % C0)</span><br><span class="line">print(<span class="string">'Duration in Seconds %7.3F'</span> % tnp1)</span><br></pre></td></tr></table></figure><p>结果：</p><p>Europen Option Value 8.037</p><p>Duration in Seconds 0.746</p><p>向量化和纯Python 相比，速度有30倍以上的提升。且估算的蒙特卡罗值和基准值很接近。在对欧拉离散公式进行对数化处理后，我们可以获得更高的效率。</p><p>欧拉离散化方法（对数形式）：<br>$$<br>logS_T=logS_{T-\Delta_t}+(r-(1/2)\sigma^2)\Delta_t + \sigma\sqrt{\Delta_t}z_t<br>$$<br>这个版本完全采用递增法，可以在Python层面上不使用任何循环的情况下实现蒙特卡罗算法。</p><p>代码：上一例中横着一行表示一条路劲，这里竖着一列表示一条路径，</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> math</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line">np.random.seed(<span class="number">20000</span>)</span><br><span class="line">t0 = time()</span><br><span class="line"><span class="comment"># Parameters</span></span><br><span class="line">S0 = <span class="number">100</span>; K=<span class="number">105</span>; T=<span class="number">1.</span>; r=<span class="number">0.05</span>; sigma=<span class="number">0.2</span></span><br><span class="line"><span class="comment"># Simulating I paths with M time steps</span></span><br><span class="line">S = S0 * np.exp(np.cumsum((r<span class="number">-0.5</span>*sigma**<span class="number">2</span>)*dt + sigma * math.sqrt(dt)</span><br><span class="line">                       * np.random.standard_normal((M+<span class="number">1</span>, I)), axis=<span class="number">0</span></span><br><span class="line">                      ))</span><br><span class="line">S[<span class="number">0</span>] = S0</span><br><span class="line">C0 = math.exp(-r*T) * np.sum(np.maximum(S[<span class="number">-1</span>]-K, <span class="number">0</span>))/I</span><br><span class="line"></span><br><span class="line">print(<span class="string">f'欧式期权定价 <span class="subst">&#123;C0&#125;</span>.'</span>)</span><br><span class="line">print(<span class="string">f'共计花费时间 <span class="subst">&#123;np.round(time()-t0,<span class="number">1</span>) &#125;</span>s.'</span>)</span><br></pre></td></tr></table></figure><p>结果：</p><p>欧式期权定价 8.165807966259603.</p><p>共计花费时间 0.6s.</p><h3 id="图形化分析"><a href="#图形化分析" class="headerlink" title="图形化分析"></a>图形化分析</h3><p>绘制前30条模拟路径：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line">plt.plot(S[:, : <span class="number">30</span>])</span><br><span class="line">plt.grid(<span class="literal">True</span>)</span><br><span class="line">plt.xlabel(<span class="string">'time step'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'index level'</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p><img src="/img/Chapter1/2.2.png" alt="22"></p><p>模拟结束时模拟指数水平的频率：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">plt.hist(S[<span class="number">-1</span>], bins=<span class="number">50</span>)</span><br><span class="line">plt.grid(<span class="literal">True</span>)</span><br><span class="line">plt.xlabel(<span class="string">'index level'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'frequency'</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p><img src="/img/Chapter1/2.3.png" alt="23"></p><p>期末期权内在价值直方图：</p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">plt.hist(np.maximum(S[<span class="number">-1</span>] - K,<span class="number">0</span>),bins = <span class="number">50</span>)</span><br><span class="line">plt.grid()</span><br><span class="line">plt.xlabel(<span class="string">'option inner value'</span>)</span><br><span class="line">plt.ylabel(<span class="string">'frequency'</span>)</span><br><span class="line">plt.ylim(<span class="number">0</span>,<span class="number">50000</span>)</span><br><span class="line">plt.show()</span><br></pre></td></tr></table></figure><p><img src="/img/Chapter1/2.4.png" alt="24"></p><h2 id="扩展-数据获取-API-接口"><a href="#扩展-数据获取-API-接口" class="headerlink" title="扩展-数据获取 API 接口"></a>扩展-数据获取 API 接口</h2><p><strong>pandas DataReader 函数</strong></p><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> pandas_datareader.data <span class="keyword">as</span> web</span><br><span class="line"></span><br><span class="line">sp500 = web.DataReader(<span class="string">'^GSPC'</span>, data_source=<span class="string">'yahoo'</span>,</span><br><span class="line">                      start=<span class="string">'3/14/2009'</span>, end=<span class="string">'4/14/2014'</span>)</span><br><span class="line">sp500.index.name = <span class="string">'Date'</span></span><br><span class="line">sp500.head()</span><br></pre></td></tr></table></figure><table><thead><tr><th align="left"></th><th align="right">High</th><th align="right">Low</th><th align="right">Open</th><th align="right">Close</th><th align="right">Volume</th><th align="right">Adj Close</th></tr></thead><tbody><tr><td align="left">Date</td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td><td align="right"></td></tr><tr><td align="left">1999-12-31</td><td align="right">1472.420044</td><td align="right">1458.189941</td><td align="right">1464.469971</td><td align="right">1469.250000</td><td align="right">374050000</td><td align="right">1469.250000</td></tr><tr><td align="left">2000-01-03</td><td align="right">1478.000000</td><td align="right">1438.359985</td><td align="right">1469.250000</td><td align="right">1455.219971</td><td align="right">931800000</td><td align="right">1455.219971</td></tr><tr><td align="left">2000-01-04</td><td align="right">1455.219971</td><td align="right">1397.430054</td><td align="right">1455.219971</td><td align="right">1399.420044</td><td align="right">1009000000</td><td align="right">1399.420044</td></tr><tr><td align="left">2000-01-05</td><td align="right">1413.270020</td><td align="right">1377.680054</td><td align="right">1399.420044</td><td align="right">1402.109985</td><td align="right">1085500000</td><td align="right">1402.109985</td></tr><tr><td align="left">2000-01-06</td><td align="right">1411.900024</td><td align="right">1392.099976</td><td align="right">1402.109985</td><td align="right">1403.449951</td><td align="right">1092300000</td><td align="right">1403.449951</td></tr></tbody></table><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">sp500[<span class="string">'42d'</span>] = np.round(pd.Series.rolling(sp500[<span class="string">'Close'</span>],window=<span class="number">42</span>).mean()) <span class="comment"># 42日均线</span></span><br><span class="line">sp500[<span class="string">'252d'</span>] = np.round(pd.Series.rolling(sp500[<span class="string">'Close'</span>],window=<span class="number">252</span>).mean()) <span class="comment">#252日均线</span></span><br><span class="line">sp500[[<span class="string">'Close'</span>,<span class="string">'42d'</span>,<span class="string">'252d'</span>]].plot(grid = <span class="literal">True</span>,figsize=(<span class="number">8</span>,<span class="number">5</span>))</span><br></pre></td></tr></table></figure><p><img src="/img/Chapter1/2.5.png" alt="25"></p><h3 id="tushare-获取数据-下载到-MySQL"><a href="#tushare-获取数据-下载到-MySQL" class="headerlink" title="tushare 获取数据 下载到 MySQL"></a>tushare 获取数据 下载到 MySQL</h3><ul><li>从 tushare 注册账号，获取 API 接口码</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> numpy <span class="keyword">as</span> np</span><br><span class="line"><span class="keyword">import</span> matplotlib.pyplot <span class="keyword">as</span> plt</span><br><span class="line"><span class="keyword">import</span> tushare <span class="keyword">as</span> ts</span><br><span class="line"></span><br><span class="line">ts.set_token(<span class="string">'tushare码'</span>)</span><br><span class="line">pro = ts.pro_api()</span><br><span class="line"></span><br><span class="line">pd.set_option(<span class="string">'display.max_columns'</span>, <span class="number">100</span>)  <span class="comment"># 设置显示数据的最大列数，防止出现省略号…，导致数据显示不全</span></span><br><span class="line">pd.set_option(<span class="string">'expand_frame_repr'</span>, <span class="literal">False</span>)  <span class="comment"># 当列太多时不自动换行</span></span><br><span class="line"></span><br><span class="line">df = pro.daily(ts_code=<span class="string">'600000.SH'</span>, start_date=<span class="string">'20200401'</span>, end_date=<span class="string">'20200630'</span>)</span><br><span class="line">df.head()</span><br></pre></td></tr></table></figure><table><thead><tr><th align="left"></th><th align="right">ts_code</th><th align="right">trade_date</th><th align="right">open</th><th align="right">high</th><th align="right">low</th><th align="right">close</th><th align="right">pre_close</th><th align="right">change</th><th align="right">pct_chg</th><th align="right">vol</th><th align="right">amount</th></tr></thead><tbody><tr><td align="left">0</td><td align="right">600000.SH</td><td align="right">20200630</td><td align="right">10.59</td><td align="right">10.64</td><td align="right">10.54</td><td align="right">10.58</td><td align="right">10.57</td><td align="right">0.01</td><td align="right">0.0946</td><td align="right">228867.64</td><td align="right">242601.910</td></tr><tr><td align="left">1</td><td align="right">600000.SH</td><td align="right">20200629</td><td align="right">10.63</td><td align="right">10.73</td><td align="right">10.49</td><td align="right">10.57</td><td align="right">10.60</td><td align="right">-0.03</td><td align="right">-0.2830</td><td align="right">278756.19</td><td align="right">295223.647</td></tr><tr><td align="left">2</td><td align="right">600000.SH</td><td align="right">20200624</td><td align="right">10.54</td><td align="right">10.61</td><td align="right">10.50</td><td align="right">10.60</td><td align="right">10.48</td><td align="right">0.12</td><td align="right">1.1450</td><td align="right">228738.84</td><td align="right">241489.165</td></tr><tr><td align="left">3</td><td align="right">600000.SH</td><td align="right">20200623</td><td align="right">10.51</td><td align="right">10.57</td><td align="right">10.47</td><td align="right">10.48</td><td align="right">10.55</td><td align="right">-0.07</td><td align="right">-0.6635</td><td align="right">196022.12</td><td align="right">206109.220</td></tr><tr><td align="left">4</td><td align="right">600000.SH</td><td align="right">20200622</td><td align="right">10.57</td><td align="right">10.66</td><td align="right">10.53</td><td align="right">10.55</td><td align="right">10.61</td><td align="right">-0.06</td><td align="right">-0.5655</td><td align="right">246119.03</td><td align="right">260728.901</td></tr></tbody></table><ul><li>保存到 MySQL</li></ul><figure class="highlight python"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> pandas <span class="keyword">as</span> pd</span><br><span class="line"><span class="keyword">import</span> pymysql</span><br><span class="line">pymysql.install_as_MySQLdb() <span class="comment">#为了兼容mysqldb</span></span><br><span class="line"><span class="keyword">from</span> sqlalchemy <span class="keyword">import</span> create_engine</span><br><span class="line">conn=create_engine(<span class="string">'mysql+pymysql://用户名:密码@localhost:本地端口/mysql数据库名?charset=utf8'</span>)</span><br><span class="line"></span><br><span class="line"><span class="comment"># 股票每日交易数据入库</span></span><br><span class="line"><span class="function"><span class="keyword">def</span> <span class="title">daily_to_mysql</span><span class="params">()</span>:</span></span><br><span class="line">    ts.set_token(<span class="string">'token码'</span>)<span class="comment">#设置token</span></span><br><span class="line">    pro = ts.pro_api()</span><br><span class="line">    df = pro.daily(ts_code=<span class="string">'000001.SZ'</span>, start_date=<span class="string">'20180701'</span>, end_date=<span class="string">'20180718'</span>)</span><br><span class="line">    df.to_sql(<span class="string">'stock_daily_basic'</span>,con=conn,if_exists=<span class="string">'append'</span>,index=<span class="literal">False</span>)</span><br><span class="line">        </span><br><span class="line"></span><br><span class="line"><span class="keyword">if</span> __name__ == <span class="string">"__main__"</span>:</span><br><span class="line">    daily_to_mysql()</span><br></pre></td></tr></table></figure><blockquote><p>Python for Finance by Yves Hilpisch(O’Reilly).Copyright 2015 Yves Hilpisch,978-1-491-94528-5</p></blockquote><div class="post-announce">感谢您的阅读，本文由 <a href="https://ChubbyLEE-Math.github.io">LEE</a> 版权所有。如若转载，请注明出处：LEE（<a href="https://ChubbyLEE-Math.github.io/2020/07/16/python%20for%20Finance,Chapter%203/">https://ChubbyLEE-Math.github.io/2020/07/16/python%20for%20Finance,Chapter%203/</a>）</div><div class="post__prevs"><div class="post__prev"><a href="/2020/07/15/Python%20for%20Finance,Chapter%201/" title="Python for Finance Chapter1"><i class="iconfont icon-prev"></i>Python for Finance Chapter1</a></div><div class="post__prev post__prev--right"></div></div></div></article><div id="comment-container"></div></div><aside class="page__sidebar"><form id="page-search-from" class="page__search-from" action="/search/"><label class="search-form__item"><input class="input" type="text" name="search" placeholder="Search..."> <i class="iconfont icon-search"></i></label></form><div class="sidebar__block"><h3 class="block__title">简介</h3><p class="block__text">日常学习与兴趣交流的个人博客</p></div><div class="sidebar__block"><h3 class="block__title">文章分类</h3><ul class="block-list"><li class="block-list-item"><a class="block-list-link" href="/categories/%E9%87%91%E8%9E%8D%E6%95%B0%E5%80%BC%E5%88%86%E6%9E%90/">金融数值分析</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/%E8%AF%BB%E4%B9%A6%E7%AC%94%E8%AE%B0/">读书笔记</a><span class="block-list-count">2</span></li><li class="block-list-item"><a class="block-list-link" href="/categories/Python/">Python</a><span class="block-list-count">8</span></li></ul></div><div class="sidebar__block"><h3 class="block__title">最新文章</h3><ul class="block-list latest-post-list"><li class="latest-post-item"><a href="/2020/07/16/python%20for%20Finance,Chapter%203/" title="Python for Finance Chapter3"><div class="item__cover"><img src="/img/11.jpg" alt="Python for Finance Chapter3"></div><div class="item__info"><h3 class="item__title">Python for Finance Chapter3</h3><span class="item__text">2020-07-16</span></div></a></li><li class="latest-post-item"><a href="/2020/07/15/Python%20for%20Finance,Chapter%201/" title="Python for Finance Chapter1"><div class="item__cover"><img src="/img/10.jpg" alt="Python for Finance Chapter1"></div><div class="item__info"><h3 class="item__title">Python for Finance Chapter1</h3><span class="item__text">2020-07-15</span></div></a></li><li class="latest-post-item"><a href="/2020/07/11/Python%20Pandas/" title="Python Pandas"><div class="item__cover"><img src="/img/9.jpg" alt="Python Pandas"></div><div class="item__info"><h3 class="item__title">Python Pandas</h3><span class="item__text">2020-07-11</span></div></a></li><li class="latest-post-item"><a href="/2020/07/11/Python%20Numpy/" title="Python Numpy"><div class="item__cover"><img src="/img/8.jpg" alt="Python Numpy"></div><div class="item__info"><h3 class="item__title">Python Numpy</h3><span class="item__text">2020-07-11</span></div></a></li></ul></div><div class="sidebar__block"><h3 class="block__title">文章标签</h3><ul class="block-list tag-list clearfix"><li class="tag-item"><a class="tag-link" href="/tags/Python-for-Finance/">Python for Finance</a></li><li class="tag-item"><a class="tag-link" href="/tags/Python%E5%9F%BA%E7%A1%80/">Python基础</a></li><li class="tag-item"><a class="tag-link" href="/tags/%E6%B5%8B%E8%AF%95/">测试</a></li></ul></div></aside></main><footer class="page__footer"><section class="footer__top"><div class="page__container footer__container"><div class="footer-top__item footer-top__item--2"><h3 class="item__title">About</h3><div class="item__content"><ul class="footer__contact-info"><p class="contact-info__item">Anyone who has never made a mistake</p><p class="contact-info__item">has never tried anything new</p><p class="contact-info__item">&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;&nbsp; &nbsp; &nbsp; &nbsp; &nbsp;—— Nikola Tesla</p><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-address"></i> <span>Shanghai, China</span></li></ul></ul></div></div><div class="footer-top__item footer__image text-align:center"><img src="/img/me.png" alt="logo" title="LEE" alt="LEE" style="border-radius:40%"></div><div class="footer-top__item footer-top__item--2"><h3 class="item__title">ME</h3><div class="item__content"><ul class="footer__contact-info"><li class="contact-info__item"><i class="iconfont icon-geren5"></i> <span>LEE</span></li><li class="contact-info__item"><i class="iconfont icon-jiaoyu"></i> <span>Doctoral Student in Statistics</span></li><li class="contact-info__item"><i class="iconfont icon-school"></i> <span>School of Math, SUFE</span></li></ul></div></div><div class="footer-top__item footer-top__item--2"><h3 class="item__title">Interests</h3><div class="item__content"><ul class="footer__contact-info"><li class="contact-info__item"><em>♔</em> <span>&nbsp; Financial Numerical Calculation</span></li><li class="contact-info__item"><em>♕</em> <span>&nbsp; Stochastic Partial Differential Equation</span></li><li class="contact-info__item"><em>♘</em> <span>&nbsp; Data Analysis and Mining</span></li><li class="contact-info__item"><em>♖</em> <span>&nbsp; Maching Learning</span></li></ul></div></div><div class="footer-top__item"><h3 class="item__title">友情链接</h3><div class="item__content"><ul class="footer-top__list"><li class="list-item"><a href="https://blog.noodler.xyz/" title="Ju’s Blog" target="_blank">胖子</a></li></ul></div></div></div></section><section class="footer__bottom"><div class="page__container footer__container"><p class="footer__copyright">© <a href="https://github.com/Mrminfive/hexo-theme-skapp" target="_blank">Skapp</a> 2020 powered by <a href="http://hexo.io/" target="_blank">Hexo</a>, made by <a href="https://github.com/Mrminfive" target="_blank">minfive</a>, author : <a href="https://github.com/ChubbyLEE-Math" target="_blank">LEE</a>.</p><ul class="footer__social-network clearfix"><li class="social-network__item"><a href="https://github.com/ChubbyLEE-Math" target="_blank" title="github"><i class="iconfont icon-github"></i></a></li><li class="social-network__item"><a href="https://weibo.com/u/7010279829/home?wvr=5" target="_blank" title="weibo"><i class="iconfont icon-weibo"></i></a></li><li class="social-network__item"><a href="https://www.zhihu.com/people/yi-wan-lu-dan-fan" target="_blank" title="zhihu"><i class="iconfont icon-zhihu"></i></a></li><li class="social-network__item"><a href="mailto:sinx@163.sufe.deu.cn" target="_blank" title="email"><i class="iconfont icon-email"></i></a></li><li class="social-network__item"><a href="/atom.xml" target="_blank" title="rss"><i class="iconfont icon-rss"></i></a></li></ul></div></section></footer><div id="back-top" class="back-top back-top--hidden js-hidden"><i class="iconfont icon-top"></i></div></div><script src="/js/common.js"></script><script src="/js/page/post.js"></script><link rel="stylesheet" href="https://unpkg.com/gitalk/dist/gitalk.css"><script src="https://unpkg.com/gitalk/dist/gitalk.min.js"></script><script src="/js/md5.min.js"></script><script>var tags=["Python for Finance"],gitalk=new Gitalk({clientID:"75ee6014d805e1edb6e8",clientSecret:"51b5a55b90593eb15d410fda25ea2552a035e423",repo:"comment",owner:"ChubbyLEE-Math",admin:["ChubbyLEE-Math"],labels:tags,id:new Date(1594893904955).getTime()>new Date("2018-02-15").getTime()?md5(location.href):location.href});gitalk.render("comment-container")</script><script async src="//busuanzi.ibruce.info/busuanzi/2.3/busuanzi.pure.mini.js"></script><script type="text/x-mathjax-config">MathJax.Hub.Config({
            tex2jax: {
                inlineMath: [ ['$','$'], ["\\(","\\)"]  ],
                processEscapes: true,
                skipTags: ['script', 'noscript', 'style', 'textarea', 'pre', 'code']
            }
            });</script><script type="text/x-mathjax-config">MathJax.Hub.Queue(function() {
            var all = MathJax.Hub.getAllJax(), i;
                for (i=0; i < all.length; i += 1) {
                all[i].SourceElement().parentNode.className += ' has-jax';
                }
            });</script><script type="text/javascript" src="//cdn.jsdelivr.net/npm/mathjax@2.7.1/MathJax.js?config=TeX-AMS-MML_HTMLorMML"></script></body></html>